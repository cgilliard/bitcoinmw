#!/bin/sh

export CC="${CC:-clang}"
export OUTPUT="${OUTPUT:-../rust-bins/macos/output}"
export MRUSTC="${MRUSTC:-../rust-bins/macos/mrustc}"


OS=$(uname -s)
if [ "$OS" = "Linux" ]; then
    MACRO_EXT=.so
    STATIC=-static
elif [ "$OS" = "Darwin" ]; then
    MACRO_EXT=.dylib
    STATIC=
else
    echo "Unsupported platform: $OS"
    exit 1
fi


case "$($CC --version 2>/dev/null)" in
    *clang*) CCFLAGS="-O3 -flto" ;;
    *gcc*) CCFLAGS="-O3 -flto=2" ;;
    *) CCFLAGS="-O3 -flto" ;;
esac

# Detect OS and set linker flags
if [ "$(uname)" = "Darwin" ]; then
    # macOS
    if ! command -v brew >/dev/null 2>&1; then
        echo "Error: Homebrew is required on macOS to locate GMP" >&2
        exit 1
    fi
    GMP_PATH="$(brew --prefix gmp)/lib/libgmp.a"
    if [ ! -f "$GMP_PATH" ]; then
        echo "Error: libgmp.a not found at $GMP_PATH. Install with 'brew install gmp'" >&2
        exit 1
    fi
    LINK_GMP="$GMP_PATH"
    LINK_SECP256K1="-lsecp256k1"  # Dynamic by default; adjust if static needed
else
    # Linux (or other UNIX-like with GNU linker)
    LINK_GMP="-lgmp"
    LINK_SECP256K1="-lsecp256k1"
fi

if [ "clean" = "$1" ]; then
    echo "Cleaning"
    cd secp256k1-zkp
    make mostlyclean-compile
    cd ..
    rm -rf .obj/* libtest.a bin/* c/bin.h
elif [ "mrustc" = "$1" ]; then
    # build xxdir and create header
    if [ ! -e bin/xxdir ] || [ build_utils/xxdir.c -nt  bin/xxdir ]; then
        echo "${CC} -o bin/xxdir build_utils/xxdir.c"
        ${CC} -o bin/xxdir build_utils/xxdir.c
    fi
    if [ ! -e c/bin.h ] || [ -n "$(find resources -type f -newer c/bin.h)" ]; then
        ./bin/xxdir ./resources c/bin.h
        touch c/bible.c
    fi

    echo "Building BitcoinMW with mrustc"
    ./scripts/secp256k1zkp.sh || exit 1
    cd c
    for file in *.c
    do
        if [ ! -e ../.obj/${file%.c}.o ] || [ ${file} -nt ../.obj/${file%.c}.o ]; then
            echo "${CC} ${CCFLAGS} -o ../.obj/${file%.c}.o -c -Ic ${file}"
            ${CC} ${CCFLAGS} -o ../.obj/${file%.c}.o -c -Ic ${file} || exit 1
        fi
    done
    cd ..

    echo "Building macros";
    # build macros
    cd macros
    ../${MRUSTC} -C panic=abort --crate-type proc-macro -L../${OUTPUT} --cfg mrustc -o ../.obj/libbitcoinmw_macros.rlib lib.rs || exit 1
    cd ..
    echo "Macros complete";

    ${MRUSTC} -C panic=abort \
        -O \
        --crate-type=lib \
        -L${OUTPUT} \
        --cfg mrustc \
        -o .obj/rust \
	--extern bitcoinmw_macros=.obj/libbitcoinmw_macros.rlib \
        rust/mod.rs || exit 1
    echo "${CC} ${CCFLAGS} ${STATIC} -o bin/bmw .obj/*.o -L.obj ${LINK_GMP} ${LINK_SECP256K1}"
    ${CC} ${CCFLAGS} ${STATIC} -o bin/bmw .obj/*.o -L.obj ${LINK_GMP} ${LINK_SECP256K1} || exit 1
else
    # build xxdir and create header
    if [ ! -e bin/xxdir ] || [ build_utils/xxdir.c -nt  bin/xxdir ]; then
        echo "${CC} -o bin/xxdir build_utils/xxdir.c"
        ${CC} -o bin/xxdir build_utils/xxdir.c
    fi
    if [ ! -e c/bin.h ] || [ -n "$(find resources -type f -newer c/bin.h)" ]; then
        ./bin/xxdir ./resources c/bin.h
        touch c/bible.c
    fi

    echo "Building BitcoinMW with rustc"
    ./scripts/secp256k1zkp.sh || exit 1
    cd c
    for file in *.c
    do
        if [ ! -e ../.obj/${file%.c}.o ] || [ ${file} -nt ../.obj/${file%.c}.o ]; then
            echo "${CC} ${CCFLAGS}  -o ../.obj/${file%.c}.o -c -Ic ${file}"
            ${CC} ${CCFLAGS} -o ../.obj/${file%.c}.o -c -Ic ${file} || exit 1
        fi
    done
    cd ..

    echo "Building macros";
    # build macros
    cd macros
    rustc -L..${OUTPUT} --crate-type=proc-macro --edition=2021 lib.rs -o ../.obj/libbitcoinmw_macros${MACRO_EXT} || exit 1;
    cd ..
    echo "Macros complete";


    rustc -C panic=abort \
        -C opt-level=3 \
	-L${OUTPUT} \
        --emit=obj \
        --crate-type=lib \
        -o .obj/rust.o \
	--extern bitcoinmw_macros=.obj/libbitcoinmw_macros${MACRO_EXT} \
        rust/mod.rs || exit 1
    echo "${CC} ${CCFLAGS} ${STATIC} -o bin/bmw .obj/*.o -L.obj ${LINK_GMP} ${LINK_SECP256K1}"
    ${CC} ${CCFLAGS} ${STATIC} -o bin/bmw .obj/*.o -L.obj ${LINK_GMP} ${LINK_SECP256K1} || exit 1
fi
